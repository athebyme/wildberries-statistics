version: '3.8'

services:
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      POSTGRES_USER: bananzza
      POSTGRES_PASSWORD: bananzza_monitor
      POSTGRES_DB: wbmonitoring
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wbuser -d wbmonitoring"]
      interval: 10s
      timeout: 5s
      retries: 5

  wb-monitoring:
    build: .
    restart: always
    depends_on:
      db:
        condition: service_healthy
    environment:
      - WB_API_KEY=
      - TELEGRAM_TOKEN=
      - TELEGRAM_CHAT_ID=447590340
      - PG_CONN_STRING=postgres://bananzza:bananzza_monitor@db:5432/wbmonitoring?sslmode=disable
      - MONITORING_INTERVAL_MIN=5  # Интервал мониторинга в минутах
      - PRODUCT_UPDATE_INTERVAL_HOUR=5
      - PRICE_THRESHOLD=30          # Порог изменения цены в процентах
      - STOCK_THRESHOLD=50          # Порог изменения остатков в процентах
      - WORKER_COUNT=5              # Количество воркеров
      - MAX_RETRIES=3               # Максимальное количество повторов запросов
      - RETRY_INTERVAL_SEC=5        # Интервал между повторами в секундах
      - REQUEST_TIMEOUT_SEC=100     # Таймаут запросов в секундах

volumes:
  postgres-data:
